<?xml version="1.0" encoding="UTF-8"?>
<form name="tmpArmasMelee" height="38" align="top" onMouseEnter="select()" onMouseLeave="select()" hitTest="true">
	<style>
	label, edit, radioButton, checkBox, comboBox, button{
		fontSize: 14;
		fontFamily: Cambria;
		textTrimming: character;
	}
	
	textEditor{
		fontSize: 14;
		fontFamily: Cambria;
		margins: {bottom=20};
	}
	
	edit, comboBox, textEditor{
		transparent: true;
	}

	edit, button {
		fontColor: white;
	}

	button {
		cursor: handPoint;
	}

	label, radioButton, checkBox, comboBox{
		fontColor: #cdcdcd;
	}

	radioButton{
		vertTextAlign: center;
		margins: {bottom=7};
	}

	horzLine{
		strokeColor: #424242;
		margins: {top=7, bottom=7};
		align: top;
	}
	
	.pts{
		fontFamily: Courier New;
		fontSize: 10;
		fontColor: #9e9e9e;
		align: left;
		vertTextAlign: leading;
		width: 40;
		transparent: true;
		readOnly: true;
		cursor: default;
		canFocus: false;
	}
	
	edit.invent{
		fontSize: 12;
	}
	
	</style>
	<script><![CDATA[	
		local function formatMoney(value)
			value = value or 0
			local inteiro, decimal = math.modf(value)
			decimal = math.abs(decimal)
			decimal = string.format("%02d", math.floor(decimal * 100 + 0.5))
			
			local formatted = tostring(inteiro)
			formatted = formatted:reverse():gsub("(%d%d%d)", "%1."):reverse()
			if formatted:sub(1,1) == "." then
				formatted = formatted:sub(2)
			end
			
			return string.format("$%s,%s", formatted, decimal)
		end

		local function parseMoney(str)
			str = str or "0"
			local num = str:gsub("[%$%s]", ""):gsub("%.", ""):gsub(",", ".")
			return tonumber(num)
		end	
		
		local function formatWeight(value)
			value = value or 0
			return tostring(value .. " lbs.")
		end

		local function parseWeight(value)
			if value == nil then return 0 end
			local t = type(value)
			if t == "number" then
				return value
			end
			if t ~= "string" then
				value = tostring(value)
			end
			local ok, s = pcall(function() return value:match("^%s*(.-)%s*$") end)
			if not ok or not s then s = value end
			ok, s = pcall(function() return s:gsub("%s*lbs?%.?$", "") end)
			if not ok or not s then s = value end
			ok, s = pcall(function() return tonumber(s) end)
			if not ok then return 0 end
			return s or 0
		end
		
		local function select()
			self.recHighlight.visible = not self.recHighlight.visible
		end
		
		local function calcSomaCarga()
			local nodoPai = NDB.getParent(NDB.getParent(sheet))
			nodoPai.cbCargaCalc = not nodoPai.cbCargaCalc
		end
	]]></script>
	
	<rectangle color="#202020" left="0" width="40" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" />
	<rectangle color="#202020" left="80" width="183" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" />
	<rectangle color="#202020" left="353" width="80" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" />
	<rectangle color="#202020" left="353" width="80" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" />
	<rectangle color="#202020" left="673" width="300" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" />
	<rectangle color="#303030" width="2000" height="38" visible="false" name="recHighlight"/>
	
	<layout height="35" align="top" margins="{top=3}">
	
		<checkBox align="left" width="30" margins="{left=10}" name="chbEquip" field="equipado" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="Item Equipado (Para CÃ¡lculo de DR e Carga)" />
		<dataLink field="equipado" defaultValue="true">
			<event name="onChange"><![CDATA[
				calcSomaCarga()
			]]></event>
		</dataLink>
		
		<edit align="left" width="40" class="invent" name="edtTL" field="TL" type="number" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="TL da Arma">
			<event name="onEnter"><![CDATA[
				if sheet.TL == "0" then sheet.TL = nil end
			]]></event>
			<event name="onExit"><![CDATA[
				if sheet.TL == nil then sheet.TL = "0" end
			]]></event>
		</edit>
		<dataLink field="TL" defaultValue="0" />
		
		<edit align="left" width="183" class="invent" name="edtNome" field="Nome" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" fontStyle="bold" hint="Nome da Arma">
			<event name="onEnter"><![CDATA[
				if sheet.Nome == "â€”" then sheet.Nome = nil end
			]]></event>
			<event name="onExit"><![CDATA[
				if sheet.Nome == nil then sheet.Nome = "â€”" end
			]]></event>
		</edit>
		<dataLink field="Nome" defaultValue="â€”" />
		
		<edit align="left" width="90" class="invent" name="edtDano" field="Dano" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="Dano da Arma">
			<event name="onEnter"><![CDATA[
				if sheet.Dano == "â€”" then sheet.Dano = nil end
			]]></event>
			<event name="onExit"><![CDATA[
				if sheet.Dano == nil then sheet.Dano = "â€”" end
			]]></event>
		</edit>
		<dataLink field="Dano" defaultValue="â€”" />
		
		<edit align="left" width="80" class="invent" name="edtAlcance" field="Alcance" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="Alcance da Arma">
			<event name="onEnter"><![CDATA[
				if sheet.Alcance == "â€”" then sheet.Alcance = nil end
			]]></event>
			<event name="onExit"><![CDATA[
				if sheet.Alcance == nil then sheet.Alcance = "â€”" end
			]]></event>
		</edit>
		<dataLink field="Alcance" defaultValue="â€”" />
		
		<edit align="left" width="50" class="invent" name="edtParry" field="Parry" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" margins="{right=190}" hint="Parry da Arma">
			<event name="onEnter"><![CDATA[
				if sheet.Parry == "â€”" then sheet.Parry = nil end
			]]></event>
			<event name="onExit"><![CDATA[
				if sheet.Parry == nil then sheet.Parry = "â€”" end
			]]></event>
		</edit>
		<dataLink field="Parry" defaultValue="â€”" />
		
		<edit align="left" width="85" class="invent" name="edtCusto" field="Custo" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="Custo da Arma">
			<event name="onEnter"><![CDATA[
				sheet.Custo = parseMoney(sheet.Custo or "0")
				self.edtCusto.type = "float"
			]]></event>
			<event name="onExit"><![CDATA[
				self.edtCusto.type = "text"
				sheet.Custo = formatMoney(sheet.Custo or 0)
			]]></event>
		</edit>
		<dataLink field="Custo" defaultValue="$0,00" />

		<edit align="left" width="60" class="invent" name="edtPeso" field="Peso" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="Peso da Arma">
			<event name="onEnter"><![CDATA[
				sheet.Peso = parseWeight(sheet.Peso or "0")
				self.edtPeso.type = "float"
			]]></event>
			<event name="onExit"><![CDATA[
				self.edtPeso.type = "text"
				sheet.Peso = formatWeight(sheet.Peso or 0)
			]]></event>
		</edit>
		<dataLink field="Peso" defaultValue="0 lbs.">
			<event name="onChange"><![CDATA[
				calcSomaCarga()
			]]></event>
		</dataLink>
		
		<edit align="left" width="30" class="invent" name="edtST" field="ST" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="Requisito de ST da Arma" />
		<dataLink field="ST" defaultValue="0" />
		
		<button align="left" width="30" name="btnInfo" text="ð¢" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" hint="InformaÃ§Ãµes da Arma">
			<event name="onClick"><![CDATA[
				local pop = self:findControlByName("popUp_")
						
				if pop ~= nil then
					pop:showPopupEx("left", self.btnInfo)
					pop:setNodeObject(sheet)
					
					sheet.TLmod = "TL" .. sheet.TL
				else
					showMessage("Ops, nÃ£o encontrei o pop-up para exibir")
				end
			]]></event>
		</button>
		
		<template name="DivisorM">
			<layout align="top" height="12" margins="{top=0, bottom=5}">
				<label align="left" text="$(texto)" width="$(largura)" fontSize="10" fontFamily="Constantia" fontStyle="bold" />
				<horzLine align="client" margins="{top=5}" strokeColor="#424242" />
			</layout>
		</template>
		
		<template name="DivisorMInfo">
			<layout align="top" height="12" margins="{top=0, bottom=5}">
				<label align="left" text="$(texto)" width="$(largura)" fontSize="10" fontFamily="Constantia" fontStyle="bold" />
				<label align="left" text="ðŸ›ˆ" name="lblInfo" width="20" hitTest="true" hint="InformaÃ§Ãµes sobre NotaÃ§Ãµes de Dano" cursor="handPoint" fontColor="white">
					<event name="onClick"><![CDATA[
						local pop = self:findControlByName("popUp_Notacao")
								
						if pop ~= nil then
							pop:showPopupEx("mouse", self.lblInfo)
							pop:setNodeObject(sheet)
						else
							showMessage("Ops, nÃ£o encontrei o pop-up para exibir")
						end
					]]></event>
				</label>
				<horzLine align="client" margins="{top=5}" strokeColor="#424242" />
			</layout>
		</template>
		
		<popup name="popUp_" width="850" height="700" backOpacity="0" drawContainer="false" autoScopeNode="false">
			<rectangle align="client" color="#101010" padding="{top=5, left=5, bottom=5, right=5}" xradius= "10" yradius="10" cornerType="bevel">
				<rectangle align="client" color="#101010" padding="{top=15, left=15, bottom=15, right=0}" xradius= "7" yradius="7" cornerType="bevel" strokeSize="1" strokeColor="#424242">
					<layout align="top" height="40">
						<label field="TLmod" align="left" textTrimming="character" fontStyle="bold" fontSize="14" width="40" />
						<label field="Nome" align="client" textTrimming="character" fontStyle="bold" fontColor="white" fontSize="20" />
						<checkBox text="E Q U I P A D O" align="right" fontSize="10" fontStyle="bold" width="95" margins="{right=10}" field="equipado" hitTest="true" hint="O Peso desse item serÃ¡ contabilizado" />
					</layout>
					<scrollBox align="client" padding="{bottom=0, right=15}">
						<flowLayout align="top" autoHeight="true" horzAlign="justify" maxControlsPerLine="4">
						
							<layout width="190" height="75">
								<DivisorM texto="A L C A N C E" largura="65" />
								<textEditor field="Alcance" align="client" hint="Alcance da Arma" />
							</layout>
							
							<layout width="190" height="75">
								<DivisorM texto="D A N O" largura="45" />
								<textEditor field="Dano" align="client" hint="Dano da Arma" />
							</layout>
							
							<layout width="190" height="75">
								<DivisorM texto="P A R R Y" largura="50" />
								<textEditor field="Parry" align="client" hint="Parry da Arma" />
							</layout>
							
							<layout width="190" height="75">
								<DivisorM texto="S T" largura="20" />
								<textEditor field="ST" align="client" hint="Requisito de ST da Arma" />
							</layout>
							
							<layout width="190" height="75">
								<DivisorM texto="C O S T   F A C T O R" largura="100" />
								<edit field="CF" name="edtPopCF" align="client" vertTextAlign="leading" hint="Cost Factor da Arma">
									<event name="onEnter"><![CDATA[
										sheet.CF = parseMoney(sheet.CF or "0")
										self.edtPopCF.type = "float"
									]]></event>
									<event name="onExit"><![CDATA[
										self.edtPopCF.type = "text"
										sheet.CF = formatMoney(sheet.CF or 0)
									]]></event>
								</edit>
								<dataLink field="CF" defaultValue="$0,00" />
							</layout>
							
							<layout width="190" height="75">
								<DivisorM texto="C U S T O" largura="50" />
								<edit field="Custo" name="edtPopCusto" align="client" vertTextAlign="leading" hint="Custo da Arma">
									<event name="onEnter"><![CDATA[
										sheet.Custo = parseMoney(sheet.Custo or "0")
										self.edtPopCusto.type = "float"
									]]></event>
									<event name="onExit"><![CDATA[
										self.edtPopCusto.type = "text"
										sheet.Custo = formatMoney(sheet.Custo or 0)
									]]></event>
								</edit>
							</layout>
							
							<layout width="190" height="75">
								<DivisorM texto="P E S O" largura="40" />
								<edit field="Peso" name="edtPopPeso" align="client" vertTextAlign="leading" hint="Peso da Arma">
									<event name="onEnter"><![CDATA[
										sheet.Peso = parseWeight(sheet.Peso or "0")
										self.edtPopPeso.type = "float"
									]]></event>
									<event name="onExit"><![CDATA[
										self.edtPopPeso.type = "text"
										sheet.Peso = formatWeight(sheet.Peso or 0)
									]]></event>
								</edit>
							</layout>
							
							<layout width="190" height="75" />
							
						</flowLayout>
						<DivisorMInfo texto="R O L A G E N S   D E   D A N O" largura="150" />
						
						<template name="linhaInfoDano">
							<rectangle align="top" height="25" color="$(cor)">
								<label align="left" text="$(info1)" fontStyle="bold" width="70" margins="{left=10}"/>
								<label align="client" text="$(info2)" />
							</rectangle>
						</template>	
						
						<template name="spacer">
							<layout align="top" height="20" />
						</template>
						
						<popup name="popUp_Notacao" width="360" height="690" backOpacity="0" drawContainer="false" autoScopeNode="false">
							<rectangle align="client" color="#353535" padding="{top=5, left=5, bottom=5, right=5}" xradius= "10" yradius="10" cornerType="bevel">
								<rectangle align="client" color="#353535" padding="{top=15, left=15, bottom=15, right=15}" xradius= "7" yradius="7" cornerType="bevel" strokeSize="1" strokeColor="#424242">
									<DivisorM texto="V A R I Ã V E I S" largura="80" />
									<linhaInfoDano cor="#202020" info1="ABRV." info2="SIGNIFICADO" />
									<linhaInfoDano cor="transparent"	info1="thr" info2="Thrusting Damage" />
									<linhaInfoDano cor="#3F3F3F"		info1="sw"	info2="Swinging Damage" />
									<spacer />
									
									<DivisorM texto="A B R E V I A Ã‡ Ã• E S" largura="100" />
									<linhaInfoDano cor="#202020" 		info1="ABRV."	info2="SIGNIFICADO" />
									<linhaInfoDano cor="transparent"	info1="aff"		info2="Affliction" />
									<linhaInfoDano cor="#3F3F3F" 		info1="burn"	info2="Burning" />
									<linhaInfoDano cor="transparent"	info1="cor" 	info2="Corrosion" />
									<linhaInfoDano cor="#3F3F3F"		info1="cr"		info2="Crushing" />
									<linhaInfoDano cor="transparent"	info1="cut" 	info2="Cutting" />
									<linhaInfoDano cor="#3F3F3F"		info1="fat" 	info2="Fatigue" />
									<linhaInfoDano cor="transparent"	info1="imp" 	info2="Impaling" />
									<linhaInfoDano cor="#3F3F3F"		info1="pi-" 	info2="Small Piercing" />
									<linhaInfoDano cor="transparent"	info1="pi"		info2="Piercing" />
									<linhaInfoDano cor="#3F3F3F"		info1="pi+" 	info2="Large Piercing" />
									<linhaInfoDano cor="transparent"	info1="pi++"	info2="Huge Piercing" />
									<linhaInfoDano cor="#3F3F3F"		info1="spec."	info2="Special" />
									<linhaInfoDano cor="transparent"	info1="tox"		info2="Toxic" />
									<linhaInfoDano cor="#3F3F3F"		info1="ex"		info2="Explosive" />
									<spacer />
									
									<DivisorM texto="N O T A Ã‡ Ã• E S" largura="80" />
									<linhaInfoDano cor="#202020" 		info1="ABRV."	info2="SIGNIFICADO" />
									<linhaInfoDano cor="transparent"	info1="[Nd]"	info2="N dados de dano de FragmentaÃ§Ã£o" />
									<linhaInfoDano cor="#3F3F3F" 		info1="(N)"		info2="Modificador de Armadura" />
									<linhaInfoDano cor="transparent"	info1="xN" 		info2="Multiplica a rolagem de dano por N" />
								</rectangle>
							</rectangle>
						</popup>
						
						<recordList align="top" autoHeight="true" name="rlDmgRolls" field="DmgRolls" templateForm="tmpRolagemdeDano">
							<event name="onEndEnumeration"><![CDATA[
								self.popUp_:needRepaint()
							]]></event>
						</recordList>
						<button text="ðŸž§" align="top" height="30" margins="{top=3, bottom=10}" onClick="self.rlDmgRolls:append()" hint="Adicionar Rolagem de Dano" />
						<DivisorM texto="D E S C R I Ã‡ Ãƒ O" largura="95" />
						<textEditor field="Descricao" align="top" height="270" hint="DescriÃ§Ã£o da Arma" />
					</scrollBox>
					<button text="ðŸ’¬" align="bottom" height="30" hint="Enviar DescriÃ§Ã£o no Chat" margins="{right=10}">
						<event name="onClick"><![CDATA[
							local function newlineToSlash(str)
								if not str then return "" end
								if str == nil then return "" end
								str = str:gsub("\r\n", "/")
								str = str:gsub("\n", "/")
								str = str:gsub("\r", "/")
								return str
							end
						
							local mesaDoPersonagem = Firecast.getMesaDe(sheet);
							local meuJogador = mesaDoPersonagem.meuJogador
							local meuNick = meuJogador.nick
							
							local msg = "ðŸ’¬ ".. meuNick .."[Â§R][Â§K2] destacou a Arma:"
							msg = msg .. "\n****\n### [Â§K1][Â§B]".. (sheet.Nome or "") .."[Â§B]\n###### ".. (sheet.TLmod or "")
							msg = msg .. "\n [Â§K1][Â§B]Dano:[Â§B] [Â§K14][Â§T]".. (newlineToSlash(sheet.Dano) or "") .. "[Â§T]"
							msg = msg .. "\n [Â§K1][Â§B]Alcance:[Â§B] [Â§K14]".. (newlineToSlash(sheet.Alcance) or "")
							msg = msg .. "\n [Â§K1][Â§B]Aparar:[Â§B] [Â§K14]".. (newlineToSlash(sheet.Parry) or "")
							msg = msg .. "\n [Â§K1][Â§B]ST:[Â§B] [Â§K14]".. (newlineToSlash(sheet.ST) or "")
							msg = msg .. "\n [Â§K1][Â§B]Custo:[Â§B] [Â§K14]".. (sheet.Custo or "")
							msg = msg .. "\n [Â§K1][Â§B]Peso:[Â§B] [Â§K14]".. (sheet.Peso or "")
							msg = msg .. "\n [Â§K1][Â§B]DescriÃ§Ã£o:[Â§B] [Â§K14]".. (sheet.Descricao or "")
							msg = msg .. "[Â§T]\n****"

							mesaDoPersonagem.activeChat:enviarMensagem(msg)
						]]></event>
					</button>
				</rectangle>
			</rectangle>
		</popup>
		
		<button align="left" width="30" text="ðŸž­" onMouseEnter="select()" onMouseLeave="select()" hitTest="true" margins="{left=2}" onClick="NDB.deleteNode(sheet) calcSomaCarga()" hint="Deletar Arma" />
		
	</layout>
</form>