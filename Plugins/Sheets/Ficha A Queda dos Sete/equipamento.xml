<?xml version="1.0" encoding="UTF-8"?>
<rectangle class="fundo">
	<scrollBox align="client">

		<popup name="BarPopup" width="140" height="66" backOpacity="0" margins="{left=4, right=4, top=4, bottom=4}" autoScopeNode="false">
			<rectangle align="client" color="white" xradius="5" yradius="5">
				<rectangle align="client" name="PopupBarColor" color="#808080" xradius="5" yradius="5" opacity="0.9">
					<label fontColor="black" margins="{left=6, top=2}" align="top" text="Valor" field="AtributoBarrinha" fontSize="12" fontStyle="bold" textTrimming="character"/>
					<layout align="client" margins="{top=2, left=4}">
						<layout align="top" height="18">
							<label fontColor="black" align="left" text="Atual:  " horzTextAlign="trailing" width="34" margins="{right=2}" fontSize="12"/>
							<comboBox fontColor="white" margins="{left=2}" align="left" transparent="false" width="40" field="ModificadorBarrinha" items="{'=', '+', '-'}" values="{'igual', 'mais', 'menos'}" value="igual"/>
							<edit fontColor="white" margins="{left=2, right=4}" type="number" align="client" field="ValorMudadoAtualBarrinha" name="currentBarValue">
								<event name="OnKeyDown">
									local oenter = (event.keyCode == 13)
									if oenter then
										self.BarPopup:close();
									end;
								</event>
							</edit>
						</layout>
						<layout align="top" height="18">
							<label fontColor="black" align="left" text="Max:  " horzTextAlign="trailing" width="34" margins="{right=2}" fontSize="12"/>
							<comboBox fontColor="white" margins="{left=2}" align="left" transparent="false" width="40" field="ModificadorBarrinhaMax" items="{'=', '+', '-'}" values="{'igual', 'mais', 'menos'}" value="igual"/>
							<edit fontColor="white" margins="{left=2, right=4}" type="number" align="client" field="ValorMudadoMaxBarrinha" name="maxBarValue">
								<event name="OnKeyDown">
									local oenter = (event.keyCode == 13);
									if oenter then
										self.BarPopup:close();
									end;
								</event>
							</edit>
						</layout>
					</layout>
				</rectangle>
			</rectangle>
			
			<event name="onClose">
				setTimeout( function()
					if (self.BarPopup.scopeNode.ModificadorBarrinha == "igual") then
						self.BarPopup.scopeNode.ValorTempAtualBarrinha = tonumber(self.BarPopup.scopeNode.ValorMudadoAtualBarrinha or 0);
					elseif (self.BarPopup.scopeNode.ModificadorBarrinha == "mais") then
						self.BarPopup.scopeNode.ValorTempAtualBarrinha = tonumber(self.BarPopup.scopeNode.ValorTempAtualBarrinha or 0) + tonumber(self.BarPopup.scopeNode.ValorMudadoAtualBarrinha or 0);
					elseif (self.BarPopup.scopeNode.ModificadorBarrinha == "menos") then
						self.BarPopup.scopeNode.ValorTempAtualBarrinha = tonumber(self.BarPopup.scopeNode.ValorTempAtualBarrinha or 0) - tonumber(self.BarPopup.scopeNode.ValorMudadoAtualBarrinha or 0);
					end;
					
					if (self.BarPopup.scopeNode.ModificadorBarrinhaMax == "igual") then
						self.BarPopup.scopeNode.ValorTempMaxBarrinha = tonumber(self.BarPopup.scopeNode.ValorMudadoMaxBarrinha or 0);
					elseif (self.BarPopup.scopeNode.ModificadorBarrinhaMax == "mais") then
						self.BarPopup.scopeNode.ValorTempMaxBarrinha = tonumber(self.BarPopup.scopeNode.ValorTempMaxBarrinha or 0) + tonumber(self.BarPopup.scopeNode.ValorMudadoMaxBarrinha or 0);
					elseif (self.BarPopup.scopeNode.ModificadorBarrinhaMax == "menos") then
						self.BarPopup.scopeNode.ValorTempMaxBarrinha = tonumber(self.BarPopup.scopeNode.ValorTempMaxBarrinha or 0) - tonumber(self.BarPopup.scopeNode.ValorMudadoMaxBarrinha or 0);
					end;
					
					local barrinhapc = 0
					local barrinhapcmax = 0
					local porcentagem = 0
					local porcentagemmax = 0

					barrinhapc = (self.BarPopup.scopeNode.ValorTempAtualBarrinha - (self.BarPopup.scopeNode.BarrinhaValor or 0));
					barrinhapcmax = (self.BarPopup.scopeNode.ValorTempMaxBarrinha - (self.BarPopup.scopeNode.BarrinhaValorMax or 0));
					self.BarPopup.scopeNode.BarrinhaValor = self.BarPopup.scopeNode.ValorTempAtualBarrinha;
					self.BarPopup.scopeNode.BarrinhaValorMax = self.BarPopup.scopeNode.ValorTempMaxBarrinha;
					
					if ((barrinhapc ~= 0) or (barrinhapcmax ~= 0)) then
						local nome = self.BarPopup.scopeNode.AtributoBarrinha or "Equipamento";
						local personagem = sheet.nome or "nome";
						local text = "[§K2]" .. nome .. "[§K3] de [§K2]" .. personagem.. "[§K3]: ";
						local valor = barrinhapc;
						local valormax = barrinhapcmax;
						
						if tonumber(barrinhapc) >= 0 then
							valor = "+" .. tostring(barrinhapc);
						end;
						if tonumber(barrinhapcmax) >= 0 then
							valormax = "+" .. tostring(barrinhapcmax);
						end;
						
						if tonumber(valormax) == 0 then
							text = text .. valor;
						else
							text = text .. valor .. "/" .. valormax;
						end;
						
						local mesaDoPersonagem = Firecast.getMesaDe(sheet);
						if mesaDoPersonagem ~= nil then
							   mesaDoPersonagem.activeChat:enviarMensagem(text);
						end;
					end;
				end, 100);
			</event>
		</popup>
		<flowLayout class="tile" align="top" height="500" margins="{left=10, right=10, top=10}" autoHeight="true" horzAlign="center" lineSpacing="3" name="fraEquipamentoLayout">

			<flowLayout class="oneLineTile" horzAlign="justify" autoHeight="true" avoidScale="true">
				<!-- MARGEM CRITICO -->
				<flowPart minWidth="280" maxWidth="800" height="64" frameStyle="frames/posCaptionEdit2/frame.xml">
					<edit align="left" class="pericia" field="critChance" width="70"/>
					<label align="client" text="MARGEM DE ATAQUE CRÍTICO" margins="{left=10}" class="tituloCampo" horzTextAlign="center"/>
				</flowPart>
				<dataLink field="critChance" defaultValue="20"/>
				<!-- DANO ADICIONAL CRITICO -->
				<flowPart minWidth="280" maxWidth="800" height="64" frameStyle="frames/posCaptionEdit2/frame.xml">
					<edit align="left" class="pericia" field="excepChance" width="70"/>
					<label align="client" text="MARGEM DE ATAQUE EXCEPCIONAL" margins="{left=10}" class="tituloCampo" horzTextAlign="center"/>
				</flowPart>
			</flowLayout>

			<flowLineBreak/>

			<!-- Equipamentos e Ataques -->
			<flowLayout name="flwPartEquipAttack" class="tile" height="250" autoHeight="true" frameStyle="frames/panel5/frame.xml">
				<layout g="col" g-width="3" name="layEquipAttackLeft" g-min-height="250">
					<label align="top" autoSize="true" text="ATAQUES" fontSize="12" vertTextAlign="center" horzTextAlign="center" fontStyle="bold"/>
					<recordList name="rclEquips" align="client" field="equipamentos.ataques" templateForm="frmEquipamentoItem" minQt="1" hitTest="true"
						margins="{top=5, bottom=5}">
						<event name="onSelect">
							local node = self.rclEquips.selectedNode;
							self.dataEquipAttackDetails.node = node;
							self.dataEquipAttackDetails.enabled = (node ~= nil);

							if self.rclEquips.lastSelectedForm ~= nil then self.rclEquips.lastSelectedForm.editName:setEnabled(false); end;
							if self.rclEquips.selectedForm ~= nil then self.rclEquips.selectedForm.editName:setEnabled(true); end;
							self.rclEquips.lastSelectedForm = self.rclEquips.selectedForm;
			            </event>
					</recordList>
					<button align="bottom" text="@@DnD5e.tab.equipament.btn.newItem" onClick="self.rclEquips.selectedNode = self.rclEquips:append(); self.rclEquips.selectedForm.editName:setFocus();"/>
				</layout>
				<layout g="col" g-width="9" name="layEquipAttackRight" g-min-height="250" g-cnt-gutter="5" g-cnt-line-spacing="5">
					<dataScopeBox name="dataEquipAttackDetails" align="client" frameStyle="frames/panel5/frame.xml" margins="{left=10}" enabled="false">
						<event name="onNodeReady">
								self.imgEquipAttackImg:setVisible(false);
						</event>
						<event name="onNodeUnready"> self.imgEquipAttackImg:setVisible(true); </event>

						<layout g="col" g-width="10" g-vert-tile="true" class="contentLayout" name="layPrincipal" margins="{left=5}">
							<flowLayout class="tile" align="top" height="15" name="optAtaqueLegenda" horzAlign="justify">
								<optAtaqueLegenda text=" " height="15" width="20"/>
								<optAtaqueLegenda text="@@DnD5e.tab.equipament.atack.lab.attack" height="15" minWidth="110" maxWidth="200"/>
								<optAtaqueLegenda text="@@DnD5e.tab.equipament.atack.lab.damage" height="15" minWidth="80" maxWidth="170"/>
								<optAtaqueLegenda text="PROPRIEDADE" height="15" minWidth="80" maxWidth="150"/>
								<optAtaqueLegenda text="@@DnD5e.tab.equipament.atack.lab.type" height="15" minWidth="80" maxWidth="180"/>
								<optAtaqueLegenda text="DURABILIDADE" height="15" minWidth="80" maxWidth="150"/>
								<optAtaqueLegenda text=" " height="25" width="25"/>
							</flowLayout>
							<recordList name="rclOptsAttack" align="client" field="optsAttack" templateForm="frmOptAtaque" minQt="1">
								
							</recordList>
							<button align="bottom" text="@@DnD5e.tab.equipament.btn.addAttackOption" onClick="self.rclOptsAttack:append();" margins="{left=150, right=150}" fontSize="11"/>
							<dataLink field="contadoresMudaram">
								<event name="onChange">
									if sheet ~= nil and self ~= nil and sheet.contadoresMudaram then
										local equip = self.dataEquipAttackDetails.node;
										if equip ~= nil then
											local optsAttack = NDB.getChildNodes(equip.optsAttack);
											for i=1,#optsAttack,1 do
												optsAttack[i].contadoresMudaram = true;
												optsAttack[i].contadoresMudaram = false;
											end;
										end;
									end;
								</event>
							</dataLink>
						</layout>

						<layout name="layEquipAttackImg" g="col" g-width="2" g-vert-tile="true">
							<image name="imgEquipAttackImg" align="client" url="https://clipartart.com/images/cross-sword-clipart.png" showProgress="false" animate='true'/>
							<image align="client" field="imagem" showProgress="false" editable="true" animate='true'/>
						</layout>
					</dataScopeBox>
				</layout>
			</flowLayout>

			<flowLineBreak/>

			<script>
				<![CDATA[
					local function recalcularTamanhoConstelation()
						self.flwPartEquipConstelation.height = self.rclEquipsConstelation.height + self.labEquipConstelation.height +
														self.layEquipConstelationBottom.height + 
														self.flwPartEquipConstelation.padding.top + self.flwPartEquipConstelation.padding.bottom + 7;
					end;
				]]>
			</script>
			 
			<flowPart name="flwPartEquipConstelation" class="tile" height="400" frameStyle="frames/panel5/frame.xml" minScaledWidth="290">
			
				<label name="labEquipConstelation" align="top" autoSize="true" text="CONSTELAÇÃO" fontSize="12" vertTextAlign="center" horzTextAlign="center" fontStyle="bold" onResize="recalcularTamanhoConstelation();"/>
				
				<scrollBox align="client">										
					<recordList name="rclEquipsConstelation" align="top" field="caracteristicas.Constelation" templateForm="frmCaracteristicasRaciais" 
							autoHeight="true" minHeight="5" onResize="recalcularTamanhoConstelation();" minQt="1" hitTest="false"/>
				</scrollBox>
							
				<layout name="layEquipConstelationBottom" align="top" height="40">
					<button name="btnEquipConstelationNew" align="left" onClick="self.rclEquipsConstelation:append();" text="@@DnD5e.tab.equipament.btn.newItem" width="160" margins="{top=4, bottom=4}"/>
				</layout>
			</flowPart>	
		</flowLayout>
	</scrollBox>
</rectangle>